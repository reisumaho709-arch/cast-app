<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CAST - メイン</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <!-- ヘッダー -->
    <div class="header">
      <div class="header-left">
        <div class="logo">CAST</div>
        <div class="user-block">
          <div id="username" class="name">ユーザー</div>
          <div id="weekday" class="weekday">1</div>
        </div>
      </div>
      <div class="header-right">
        <div class="icon-btn" id="checkBtn" title="忘れ物チェック">🧰</div>
        <div class="icon-btn" id="bellBtn" title="アラーム">🔔</div>
        <div class="icon-btn" id="settingsBtn" title="設定">⚙️</div>
      </div>
    </div>

    <!-- メイン3カラム -->
    <div class="grid">
      <!-- 左：今日の予定 -->
      <div class="left-panel" id="leftPanel">
        <h3 style="margin-bottom:10px">本日の予定</h3>
        <div id="todayList"></div>
      </div>

      <!-- 中央：現在の予定＋メモ -->
      <div class="center-panel">
        <div class="big-card" id="bigCard">
          <div class="title" id="currentTitle">予定がありません</div>
          <div class="time" id="currentTime">00:00 — 00:00</div>
          <div class="remaining" id="remaining">— 分</div>

          <div class="side-cards">
            <div class="small-card" id="next1">次予定：なし</div>
            <div class="small-card" id="next2">次々予定：なし</div>
          </div>

          <div class="memos" id="memos"></div>
          <div class="bottom-clock" id="clock">--:--:--</div>
        </div>
      </div>

      <!-- 右：ショートカット -->
      <div>
        <div style="background:linear-gradient(180deg,#0d1113,#0a0a0a);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)">
          <div style="margin-bottom:8px;font-weight:700">ショートカット</div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <a class="btn" href="calendar.html">📅 共有カレンダー</a>
            <a class="btn" href="kakeibo.html">💰 家計簿</a>
            <button class="btn alt" id="addMemoQuick">メモ追加</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 音声 -->
  <audio id="alarmSound" src="Meitetsu.mp3" preload="auto"></audio>

  <!-- モーダル -->
  <div class="modal" id="checkModal">
    <div class="panel">
      <h3>忘れ物チェック</h3>
      <div class="check-list" id="checkList"></div>
      <div style="margin-top:12px;text-align:right">
        <button class="btn" id="checkConfirm">確認</button>
        <button class="btn alt" onclick="closeModal('checkModal')">閉じる</button>
      </div>
    </div>
  </div>

  <div class="modal" id="settingsModal">
    <div class="panel">
      <h3>設定</h3>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn" id="openAddEvent">予定追加</button>
        <button class="btn" id="openAddMemo">メモ追加</button>
        <a class="btn" href="calendar.html">共有カレンダー</a>
        <a class="btn" href="kakeibo.html">家計簿</a>
      </div>
      <div style="margin-top:12px;text-align:right">
        <button class="btn alt" onclick="closeModal('settingsModal')">閉じる</button>
      </div>
    </div>
  </div>

  <!-- 予定追加 -->
  <div class="modal" id="addEventModal">
    <div class="panel">
      <h3>予定を追加</h3>
      <div class="form-row"><label>日付</label><input id="evDate" class="input" type="date" /></div>
      <div class="form-row"><label>開始</label><input id="evStart" class="input" type="time" /></div>
      <div class="form-row"><label>終了</label><input id="evEnd" class="input" type="time" /></div>
      <div class="form-row"><label>タイトル</label><input id="evTitle" class="input" type="text" /></div>
      <div style="text-align:right">
        <button class="btn" id="saveEventBtn">追加</button>
        <button class="btn alt" onclick="closeModal('addEventModal')">閉じる</button>
      </div>
    </div>
  </div>

  <!-- メモ追加 -->
  <div class="modal" id="addMemoModal">
    <div class="panel">
      <h3>メモを追加</h3>
      <div class="form-row"><label>題名</label><input id="memoTitle" class="input" type="text" /></div>
      <div class="form-row"><label>内容</label><textarea id="memoBody" class="input" rows="5"></textarea></div>
      <div style="text-align:right">
        <button class="btn" id="saveMemoBtn">保存</button>
        <button class="btn alt" onclick="closeModal('addMemoModal')">閉じる</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./firebase-config.js";
    import {
      collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, doc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const el = id => document.getElementById(id);
    const user = localStorage.getItem("loginUser");
    if (!user) location.href = "login.html";
    el("username").textContent = user;

    // 曜日
    const wd = ["日","月","火","水","木","金","土"];
    el("weekday").textContent = wd[new Date().getDay()];

    // 忘れ物リスト
    const checklist = ["財布","鍵","スマホ","ハンカチ","飲み物"];
    const cList = el("checkList");
    checklist.forEach(i=>{
      const d = document.createElement("div");
      d.className="check-item";
      d.textContent=i;
      d.onclick=()=>d.classList.toggle("checked");
      cList.appendChild(d);
    });
    el("checkConfirm").onclick=()=>closeModal("checkModal");

    // モーダル
    window.openModal=id=>el(id).classList.add("show");
    window.closeModal=id=>el(id).classList.remove("show");

    el("checkBtn").onclick=()=>openModal("checkModal");
    el("settingsBtn").onclick=()=>openModal("settingsModal");
    el("openAddEvent").onclick=()=>{closeModal("settingsModal");openModal("addEventModal");};
    el("openAddMemo").onclick=()=>{closeModal("settingsModal");openModal("addMemoModal");};
    el("addMemoQuick").onclick=()=>openModal("addMemoModal");

    // アラーム
    el("bellBtn").onclick=()=>{
      const s=el("alarmSound");
      s.play(); setTimeout(()=>s.pause(),3000);
    };

    // Firestore参照
    const evCol=collection(db,"events");
    const memoCol=collection(db,"memos");
    const today=()=>new Date().toISOString().slice(0,10);

    let events=[];
    onSnapshot(query(evCol,where("date","==",today()),orderBy("start")),snap=>{
      events=snap.docs.map(d=>({...d.data(),id:d.id}));
      renderEvents();
      updateDisplay();
    });

    function renderEvents(){
      const box=el("todayList");
      box.innerHTML="";
      events.forEach(e=>{
        const div=document.createElement("div");
        div.className="event-item";
        div.innerHTML=`<div class="event-time">${e.start}〜${e.end}</div><div>${e.title}</div>`;
        div.onclick=()=>alert(`${e.title}\n${e.start}〜${e.end}`);
        box.appendChild(div);
      });
    }

    function updateDisplay(){
      const now=new Date();const min=now.getHours()*60+now.getMinutes();
      const parsed=events.map(e=>{
        const [sh,sm]=e.start.split(":").map(Number);
        const [eh,em]=e.end.split(":").map(Number);
        return {...e,sMin:sh*60+sm,eMin:eh*60+em};
      }).sort((a,b)=>a.sMin-b.sMin);

      const current=parsed.find(p=>p.sMin<=min&&p.eMin>min);
      const next=parsed.find(p=>p.sMin>min);
      const next2=parsed.filter(p=>p.sMin>min)[1];

      el("currentTitle").textContent=current?current.title:"予定がありません";
      el("currentTime").textContent=current?`${current.start}〜${current.end}`:"--:-- — --:--";
      el("next1").textContent=next?`次：${next.title}`:"次：なし";
      el("next2").textContent=next2?`次々：${next2.title}`:"次々：なし";
      el("remaining").textContent=current?(current.eMin-min)+"分":"— 分";
    }

    setInterval(()=>{
      el("clock").textContent=new Date().toLocaleTimeString();
      updateDisplay();
    },1000);

    // 予定保存
    el("saveEventBtn").onclick=async()=>{
      const data={
        date:el("evDate").value||today(),
        start:el("evStart").value,
        end:el("evEnd").value,
        title:el("evTitle").value,
        owner:user,
        createdAt:serverTimestamp()
      };
      await addDoc(evCol,data);
      closeModal("addEventModal");
    };

    // メモ保存
    el("saveMemoBtn").onclick=async()=>{
      const data={
        title:el("memoTitle").value,
        body:el("memoBody").value,
        owner:user,
        createdAt:serverTimestamp()
      };
      await addDoc(memoCol,data);
      closeModal("addMemoModal");
    };

    // メモ表示
    onSnapshot(query(memoCol,orderBy("createdAt","desc")),snap=>{
      const out=el("memos");out.innerHTML="";
      snap.forEach(d=>{
        const m=d.data();
        const div=document.createElement("div");
        div.className="memo-card";
        div.innerHTML=`<div class="memo-title">${m.title}</div><div class="memo-body">${m.body}</div>`;
        out.appendChild(div);
      });
    });
  </script>
</body>
</html>

