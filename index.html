<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CAST - ãƒ¡ã‚¤ãƒ³</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="logo">CAST</div>
      <div class="user-info">
        <div id="username">ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
        <div id="weekday"></div>
      </div>
      <div class="icons">
        <button id="checkBtn" title="å¿˜ã‚Œç‰©ãƒã‚§ãƒƒã‚¯">ğŸ§°</button>
        <button id="bellBtn" title="ã‚¢ãƒ©ãƒ¼ãƒ ">ğŸ””</button>
        <button id="settingsBtn" title="è¨­å®š">âš™ï¸</button>
      </div>
    </header>

    <main class="main-grid">
      <section class="panel left-panel">
        <h3>æœ¬æ—¥ã®äºˆå®š</h3>
        <div id="todayList"></div>
      </section>

      <section class="panel center-panel">
        <div id="bigCard" class="big-card">
          <h2 id="currentTitle">äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“</h2>
          <p id="currentTime">--:-- â€” --:--</p>
          <p id="remaining">â€” åˆ†</p>
          <div class="side-cards">
            <div id="next1">æ¬¡äºˆå®šï¼šãªã—</div>
            <div id="next2">æ¬¡ã€…äºˆå®šï¼šãªã—</div>
          </div>
          <div id="memos" class="memos"></div>
          <div id="clock" class="bottom-clock"></div>
        </div>
      </section>

      <section class="panel right-panel">
        <h3>ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</h3>
        <a class="btn" href="calendar.html">å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>
        <a class="btn" href="kakeibo.html">å®¶è¨ˆç°¿</a>
        <button class="btn alt" id="addMemoQuick">ãƒ¡ãƒ¢è¿½åŠ </button>
      </section>
    </main>
  </div>

  <!-- å¿˜ã‚Œç‰©ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="checkModal" class="modal">
    <div class="modal-panel">
      <h3>å¿˜ã‚Œç‰©ãƒã‚§ãƒƒã‚¯</h3>
      <div id="checkList"></div>
      <div class="modal-footer">
        <button class="btn" id="checkConfirm">ç¢ºèª</button>
        <button class="btn alt" onclick="closeModal('checkModal')">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="settingsModal" class="modal">
    <div class="modal-panel">
      <h3>è¨­å®š</h3>
      <button class="btn" id="openAddEvent">äºˆå®šè¿½åŠ </button>
      <button class="btn" id="openAddMemo">ãƒ¡ãƒ¢è¿½åŠ </button>
      <button class="btn alt" onclick="closeModal('settingsModal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- äºˆå®šè¿½åŠ  -->
  <div id="addEventModal" class="modal">
    <div class="modal-panel">
      <h3>äºˆå®šã‚’è¿½åŠ </h3>
      <input id="evDate" class="input" type="date" />
      <input id="evStart" class="input" type="time" />
      <input id="evEnd" class="input" type="time" />
      <input id="evTitle" class="input" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" />
      <button class="btn" id="saveEventBtn">ä¿å­˜</button>
      <button class="btn alt" onclick="closeModal('addEventModal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- ãƒ¡ãƒ¢è¿½åŠ  -->
  <div id="addMemoModal" class="modal">
    <div class="modal-panel">
      <h3>ãƒ¡ãƒ¢ã‚’è¿½åŠ </h3>
      <input id="memoTitle" class="input" type="text" placeholder="é¡Œå" />
      <textarea id="memoBody" class="input" rows="4" placeholder="å†…å®¹"></textarea>
      <button class="btn" id="saveMemoBtn">ä¿å­˜</button>
      <button class="btn alt" onclick="closeModal('addMemoModal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <audio id="alarmSound" src="Meitetsu.mp3" preload="auto"></audio>

  <script type="module">
    import { db } from "./firebase-config.js";
    import {
      collection, addDoc, onSnapshot, query, where, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const el = id => document.getElementById(id);
    const user = localStorage.getItem("loginUser") || prompt("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›:");
    localStorage.setItem("loginUser", user);
    el("username").textContent = user;

    const days = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
    el("weekday").textContent = days[new Date().getDay()];

    // å¿˜ã‚Œç‰©ãƒã‚§ãƒƒã‚¯
    const items = ["è²¡å¸ƒ","ã‚¹ãƒãƒ›","éµ","ãƒãƒ³ã‚«ãƒ","æ°´ç­’"];
    const checkList = el("checkList");
    items.forEach(i=>{
      const div=document.createElement("div");
      div.textContent=i;
      div.className="check-item";
      div.onclick=()=>div.classList.toggle("checked");
      checkList.appendChild(div);
    });
    el("checkBtn").onclick=()=>openModal("checkModal");
    el("checkConfirm").onclick=()=>closeModal("checkModal");

    // clock
    setInterval(()=>el("clock").textContent=new Date().toLocaleTimeString(),1000);

    // modal
    window.openModal=id=>el(id).classList.add("show");
    window.closeModal=id=>el(id).classList.remove("show");

    // firestore
    const todayStr=new Date().toISOString().split("T")[0];
    const eventsCol=collection(db,"events");
    const memosCol=collection(db,"memos");

    // event listener
    el("saveEventBtn").onclick=async()=>{
      await addDoc(eventsCol,{
        date:el("evDate").value||todayStr,
        start:el("evStart").value,
        end:el("evEnd").value,
        title:el("evTitle").value,
        owner:user,
        createdAt:serverTimestamp()
      });
      closeModal("addEventModal");
    };

    el("saveMemoBtn").onclick=async()=>{
      await addDoc(memosCol,{
        title:el("memoTitle").value,
        body:el("memoBody").value,
        owner:user,
        createdAt:serverTimestamp()
      });
      closeModal("addMemoModal");
    };

    // realtime memos
    onSnapshot(query(memosCol,orderBy("createdAt","desc")),snap=>{
      const m=el("memos");m.innerHTML="";
      snap.forEach(d=>{
        const data=d.data();
        const div=document.createElement("div");
        div.className="memo-card";
        div.innerHTML=`<div>${data.title}</div><p>${data.body}</p>`;
        m.appendChild(div);
      });
    });

    // realtime events
    onSnapshot(query(eventsCol,where("date","==",todayStr),orderBy("start")),snap=>{
      const list=el("todayList");list.innerHTML="";
      snap.forEach(d=>{
        const e=d.data();
        const div=document.createElement("div");
        div.className="event-item";
        div.innerHTML=`<b>${e.start}-${e.end}</b> ${e.title}`;
        list.appendChild(div);
      });
    });
  </script>
</body>
</html>

