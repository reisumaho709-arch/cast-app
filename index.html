<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CAST - ãƒ¡ã‚¤ãƒ³</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="header-left">
        <div class="logo">CAST</div>
        <div class="user-block">
          <div id="username" class="name">ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
          <div id="weekday" class="weekday">1</div>
        </div>
      </div>
      <div class="header-right">
        <div class="icon-btn" id="checkBtn" title="å¿˜ã‚Œç‰©ãƒã‚§ãƒƒã‚¯">ğŸ§°</div>
        <div class="icon-btn" id="bellBtn" title="ã‚¢ãƒ©ãƒ¼ãƒ ">ğŸ””</div>
        <div class="icon-btn" id="settingsBtn" title="è¨­å®š">âš™ï¸</div>
      </div>
    </div>

    <div class="grid">
      <div class="left-panel">
        <h3>æœ¬æ—¥ã®äºˆå®š</h3>
        <div id="todayList"></div>
      </div>

      <div class="center-panel">
        <div class="big-card" id="bigCard">
          <div class="title" id="currentTitle">äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“</div>
          <div class="time" id="currentTime">00:00 â€” 00:00</div>
          <div class="remaining" id="remaining">â€” åˆ†</div>
          <div class="side-cards">
            <div class="small-card" id="next1">æ¬¡äºˆå®šï¼šãªã—</div>
            <div class="small-card" id="next2">æ¬¡ã€…äºˆå®šï¼šãªã—</div>
          </div>
          <div class="memos" id="memos"></div>
          <div class="bottom-clock" id="clock">--:--:--</div>
        </div>
      </div>

      <div class="right-panel">
        <div class="panel">
          <h3>ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</h3>
          <a class="btn" href="calendar.html">å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>
          <a class="btn" href="kakeibo.html">å®¶è¨ˆç°¿</a>
          <button class="btn alt" id="addMemoQuick">ãƒ¡ãƒ¢è¿½åŠ </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="addMemoModal">
    <div class="panel">
      <h3>ãƒ¡ãƒ¢ã‚’è¿½åŠ </h3>
      <input id="memoTitle" class="input" placeholder="é¡Œå">
      <textarea id="memoBody" class="input" rows="4" placeholder="å†…å®¹"></textarea>
      <div style="margin-top:10px;text-align:right">
        <button class="btn" id="saveMemoBtn">ä¿å­˜</button>
        <button class="btn alt" onclick="closeModal('addMemoModal')">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <audio id="alarmSound" src="Meitetsu.mp3" preload="auto"></audio>

  <script type="module">
    import { db } from "./firebase-config.js";
    import { collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const el = (id) => document.getElementById(id);

    // ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª
    const currentUser = localStorage.getItem("loginUser");
    if (!currentUser) location.href = "login.html";
    el("username").textContent = currentUser;

    // æ›œæ—¥
    const weekdayNames = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
    el("weekday").textContent = weekdayNames[new Date().getDay()];

    // ãƒ¢ãƒ¼ãƒ€ãƒ«
    window.openModal = (id) => el(id).classList.add("show");
    window.closeModal = (id) => el(id).classList.remove("show");
    el("addMemoQuick").onclick = () => openModal("addMemoModal");

    // ãƒ¡ãƒ¢ä¿å­˜
    const memosCol = collection(db, "memos");
    el("saveMemoBtn").onclick = async () => {
      const title = el("memoTitle").value || "ç„¡é¡Œ";
      const body = el("memoBody").value || "";
      await addDoc(memosCol, {
        title,
        body,
        owner: currentUser,
        createdAt: serverTimestamp(),
      });
      closeModal("addMemoModal");
      el("memoTitle").value = "";
      el("memoBody").value = "";
    };

    // ãƒ¡ãƒ¢è¡¨ç¤º
    onSnapshot(memosCol, (snap) => {
      const out = el("memos");
      out.innerHTML = "";
      snap.forEach((doc) => {
        const d = doc.data();
        const card = document.createElement("div");
        card.className = "memo-card";
        card.innerHTML = `
          <div class="memo-title">${d.title}</div>
          <div class="memo-body">${d.body}</div>
          <div class="memo-owner">${d.owner || "åŒ¿å"}</div>`;
        out.appendChild(card);
      });
    });

    // æ™‚è¨ˆ
    setInterval(() => {
      el("clock").textContent = new Date().toLocaleTimeString();
    }, 1000);
  </script>
</body>
</html>

