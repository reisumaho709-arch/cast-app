<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CAST共有カレンダー</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      background: linear-gradient(180deg, #000000 0%, #1a1a1a 100%);
      color: white;
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #111;
      padding: 15px 20px;
      border-bottom: 2px solid #00aaff;
    }

    .user-info {
      font-size: 18px;
      color: #00aaff;
    }

    .menu {
      display: flex;
      gap: 15px;
    }

    .menu button {
      background: #0078d7;
      border: none;
      border-radius: 8px;
      color: white;
      padding: 8px 15px;
      cursor: pointer;
    }

    .menu button:hover {
      background: #0099ff;
    }

    .calendar-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 90%;
      margin-bottom: 10px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      width: 90%;
      text-align: center;
    }

    .day {
      padding: 10px;
      border-radius: 10px;
      background: #222;
      cursor: pointer;
      transition: background 0.3s;
    }

    .day:hover {
      background: #333;
    }

    .event {
      font-size: 12px;
      margin-top: 5px;
      background: #0078d7;
      border-radius: 6px;
      padding: 3px;
      color: white;
    }

    .event.other {
      background: orange;
    }

    #eventList {
      margin-top: 20px;
      background: #111;
      padding: 10px;
      border-radius: 12px;
      width: 85%;
      max-height: 200px;
      overflow-y: auto;
    }

    #addEventBtn {
      margin-top: 15px;
      background: #00aaff;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    #addEventBtn:hover {
      background: #0099ff;
    }

    #eventModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.7);
    }

    .modal-content {
      background: #222;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }

    input, textarea {
      width: 90%;
      margin: 10px 0;
      border-radius: 8px;
      border: none;
      padding: 8px;
      background: #111;
      color: white;
    }

    .close {
      background: #ff3333;
      border: none;
      border-radius: 8px;
      color: white;
      padding: 8px 16px;
      cursor: pointer;
    }

  </style>
</head>
<body>
  <header>
    <div class="user-info" id="userName">ユーザー</div>
    <div class="menu">
      <button onclick="location.href='main.html'">メイン</button>
      <button onclick="location.href='kakeibo.html'">家計簿</button>
    </div>
  </header>

  <div class="calendar-container">
    <div class="calendar-header">
      <button onclick="prevMonth()">&lt;</button>
      <h2 id="monthYear"></h2>
      <button onclick="nextMonth()">&gt;</button>
    </div>

    <div class="calendar-grid" id="calendar"></div>

    <div id="eventList"></div>

    <button id="addEventBtn" onclick="openModal()">予定を追加</button>
  </div>

  <div id="eventModal">
    <div class="modal-content">
      <h3>予定を追加</h3>
      <input type="date" id="eventDate" />
      <input type="time" id="eventTime" />
      <textarea id="eventText" placeholder="予定内容"></textarea>
      <button onclick="saveEvent()">保存</button>
      <button class="close" onclick="closeModal()">閉じる</button>
    </div>
  </div>

  <script type="module">
    import { app, db } from "./firebase-config.js";
    import { collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const userName = localStorage.getItem("loginUser") || "ゲスト";
    document.getElementById("userName").textContent = userName;

    const calendar = document.getElementById("calendar");
    const eventList = document.getElementById("eventList");

    let currentDate = new Date();
    let selectedDate = null;
    const eventsRef = collection(db, "events");

    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      document.getElementById("monthYear").textContent = `${year}年 ${month + 1}月`;

      calendar.innerHTML = "";
      for (let i = 0; i < firstDay; i++) {
        const empty = document.createElement("div");
        calendar.appendChild(empty);
      }
      for (let d = 1; d <= daysInMonth; d++) {
        const dayDiv = document.createElement("div");
        dayDiv.className = "day";
        dayDiv.textContent = d;
        dayDiv.onclick = () => selectDate(`${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`);
        calendar.appendChild(dayDiv);
      }
    }

    renderCalendar();

    function prevMonth() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    }

    function nextMonth() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    }

    function selectDate(date) {
      selectedDate = date;
      loadEvents();
    }

    function loadEvents() {
      eventList.innerHTML = `<h3>${selectedDate} の予定</h3>`;
      const q = query(eventsRef, orderBy("date", "asc"));
      onSnapshot(q, (snapshot) => {
        eventList.innerHTML = `<h3>${selectedDate} の予定</h3>`;
        snapshot.forEach((doc) => {
          const data = doc.data();
          if (data.date === selectedDate) {
            const div = document.createElement("div");
            div.className = "event" + (data.user !== userName ? " other" : "");
            div.textContent = `${data.time} ${data.text} (${data.user})`;
            eventList.appendChild(div);
          }
        });
      });
    }

    window.openModal = () => {
      document.getElementById("eventModal").style.display = "flex";
    };

    window.closeModal = () => {
      document.getElementById("eventModal").style.display = "none";
    };

    window.saveEvent = async () => {
      const date = document.getElementById("eventDate").value;
      const time = document.getElementById("eventTime").value;
      const text = document.getElementById("eventText").value.trim();

      if (!date || !time || !text) return alert("全て入力してください");

      await addDoc(eventsRef, {
        user: userName,
        date,
        time,
        text,
        created: new Date()
      });

      alert("予定を保存しました！");
      closeModal();
      loadEvents();
    };
  </script>
</body>
</html>
