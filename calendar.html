<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CAST - カレンダー</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div><a href="main.html" class="btn alt">← メインへ</a></div>
      <div style="font-size:20px;font-weight:700">共有カレンダー</div>
      <div><a href="kakeibo.html" class="btn alt">家計簿へ</a></div>
    </div>

    <div id="calendarWrap" style="background:#0b0b0b;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
        <button id="prevMonth" class="btn alt">前</button>
        <button id="nextMonth" class="btn alt">次</button>
        <div id="monthLabel" style="font-weight:700;margin-left:8px"></div>
      </div>

      <div id="calendarGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px"></div>
    </div>
  </div>

  <!-- day modal -->
  <div class="modal" id="dayModal">
    <div class="panel">
      <h3 id="dayTitle">日付</h3>
      <div id="dayEvents" style="margin-bottom:12px"></div>
      <h4>予定を追加</h4>
      <div class="form-row"><label>時間（開始）</label><input id="calStart" class="input" type="time"></div>
      <div class="form-row"><label>時間（終了）</label><input id="calEnd" class="input" type="time"></div>
      <div class="form-row"><label>タイトル</label><input id="calTitle" class="input" type="text"></div>
      <div style="text-align:right">
        <button class="btn" id="calAddBtn">追加</button>
        <button class="btn alt" onclick="closeModal('dayModal')">閉じる</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from './firebase-config.js';
    import { collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    const currentUser = localStorage.getItem('loginUser') || null;
    if (!currentUser) window.location.href = 'login.html';

    const monthLabel = document.getElementById('monthLabel');
    const calendarGrid = document.getElementById('calendarGrid');
    let viewDate = new Date();

    const eventsCol = collection(db,'events');

    function renderCalendar(date){
      calendarGrid.innerHTML='';
      const year = date.getFullYear(), month=date.getMonth();
      monthLabel.textContent = `${month+1}月 ${year}`;

      // first day of month weekday (0=Sun)
      const first = new Date(year, month, 1);
      const startDay = first.getDay();
      const days = new Date(year, month+1, 0).getDate();

      // add blanks
      for(let i=0;i<startDay;i++){
        const empty = document.createElement('div');
        empty.style.minHeight='80px';empty.style.background='rgba(255,255,255,0.01)';empty.style.borderRadius='6px';
        calendarGrid.appendChild(empty);
      }

      // each day
      for(let d=1;d<=days;d++){
        const cell = document.createElement('div');
        cell.style.minHeight='80px';cell.style.padding='6px';cell.style.borderRadius='6px';
        cell.style.background='rgba(255,255,255,0.01)';cell.style.cursor='pointer';
        const dateStr = `${year}-${('0'+(month+1)).slice(-2)}-${('0'+d).slice(-2)}`;
        cell.innerHTML = `<div style="font-weight:700">${d}</div><div id="ev-${dateStr}" style="margin-top:6px;font-size:12px;color:var(--muted)"></div>`;
        cell.onclick = ()=> openDayModal(dateStr);
        calendarGrid.appendChild(cell);
      }
    }

    // load events for visible month (simple)
    function loadMonthEvents(){
      const y = viewDate.getFullYear();
      const m = ('0'+(viewDate.getMonth()+1)).slice(-2);
      // naive: listen whole collection and filter
      onSnapshot(query(eventsCol, orderBy('date')), snap=>{
        // clear all small labels
        document.querySelectorAll('[id^="ev-"]').forEach(x=>x.innerHTML='');
        snap.forEach(docu=>{
          const d = docu.data();
          const el = document.getElementById('ev-' + d.date);
          if (el){
            // show a small dot or short title
            const span = document.createElement('div');
            span.textContent = d.start + ' ' + d.title;
            span.style.whiteSpace='nowrap'; span.style.overflow='hidden'; span.style.textOverflow='ellipsis';
            span.style.color = (d.owner && d.owner !== currentUser) ? 'var(--orange)' : 'var(--accent-2)';
            el.appendChild(span);
          }
        });
      });
    }

    // day modal handlers
    function openDayModal(dateStr){
      openModal('dayModal');
      document.getElementById('dayTitle').textContent = dateStr;
      // load events for that day
      const list = document.getElementById('dayEvents'); list.innerHTML='';

      // query events for date
      // naive: listen once via onSnapshot with where
      const q = query(eventsCol, where('date','==', dateStr), orderBy('start'));
      const unsub = onSnapshot(q, snap=>{
        list.innerHTML='';
        snap.forEach(docu=>{
          const d = docu.data();
          const wrapper = document.createElement('div');
          wrapper.style.display='flex';wrapper.style.justifyContent='space-between';wrapper.style.padding='6px 0';
          const left = document.createElement('div'); left.textContent = `${d.start} - ${d.end} ${d.title} (${d.owner||'誰か'})`;
          const del = document.createElement('button'); del.className='btn alt'; del.textContent='削除';
          del.onclick = async ()=> {
            if (confirm('削除しますか？')) {
              await deleteDoc(doc(db,'events',docu.id));
            }
          };
          wrapper.appendChild(left); wrapper.appendChild(del); list.appendChild(wrapper);
        });
      });

      // set add button
      document.getElementById('calAddBtn').onclick = async ()=>{
        const start = document.getElementById('calStart').value || '00:00';
        const end = document.getElementById('calEnd').value || '00:00';
        const title = document.getElementById('calTitle').value || '無題';
        await addDoc(collection(db,'events'),{date:dateStr,start,end,title,owner:currentUser,createdAt:serverTimestamp()});
        document.getElementById('calTitle').value='';
      };

      // cleanup unsub when modal closed
      document.getElementById('dayModal').ontransitionend = ()=>{};
    }

    // open/close modal helpers
    window.openModal = id => document.getElementById(id).classList.add('show');
    window.closeModal = id => document.getElementById(id).classList.remove('show');

    document.getElementById('prevMonth').onclick = ()=> { viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()-1,1); renderCalendar(viewDate); loadMonthEvents(); };
    document.getElementById('nextMonth').onclick = ()=> { viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()+1,1); renderCalendar(viewDate); loadMonthEvents(); };

    renderCalendar(viewDate);
    loadMonthEvents();

  </script>
</body>
</html>
