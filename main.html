<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CAST - ãƒ¡ã‚¤ãƒ³</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      background: linear-gradient(180deg, #000000, #141414);
      color: #fff;
      font-family: "Segoe UI", sans-serif;
      margin: 0;
    }

    .app {
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #0a0a0a;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      font-size: 22px;
      font-weight: bold;
      color: #00aaff;
    }

    .user-block {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .weekday {
      font-size: 14px;
      color: #bbb;
    }

    .header-right {
      display: flex;
      gap: 12px;
      font-size: 22px;
    }

    .icon-btn {
      cursor: pointer;
      transition: 0.3s;
    }

    .icon-btn:hover {
      transform: scale(1.2);
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .left-panel, .center-panel, .right-panel {
      background: #0d0d0d;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.05);
    }

    .event-item {
      padding: 8px;
      margin-bottom: 6px;
      background: #111;
      border-radius: 6px;
      cursor: pointer;
    }

    .event-item.other {
      opacity: 0.6;
    }

    .big-card {
      background: #111;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }

    .small-card {
      background: #222;
      border-radius: 6px;
      padding: 6px;
      margin-top: 8px;
    }

    .memo-card {
      display: inline-block;
      background: #222;
      border-left: 3px solid #00aaff;
      border-radius: 8px;
      padding: 8px;
      margin-right: 8px;
      width: 160px;
      overflow: hidden;
    }

    .memo-title {
      font-weight: bold;
      color: #00aaff;
    }

    .bottom-clock {
      font-size: 20px;
      margin-top: 12px;
      color: #ccc;
    }

    .btn {
      background: #0078d7;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      text-align: center;
      transition: background 0.2s;
    }

    .btn:hover { background: #0099ff; }

    .modal {
      display: none;
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .panel {
      background: #111;
      border-radius: 12px;
      padding: 20px;
      width: 300px;
      text-align: center;
    }

    .input {
      width: 90%;
      padding: 8px;
      border-radius: 6px;
      border: none;
      background: #222;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="header-left">
        <div class="logo">CAST</div>
        <div class="user-block">
          <div id="username" class="name">ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
          <div id="weekday" class="weekday"></div>
        </div>
      </div>

      <div class="header-right">
        <div class="icon-btn" id="checkBtn">ğŸ§°</div>
        <div class="icon-btn" id="bellBtn">ğŸ””</div>
        <div class="icon-btn" id="settingsBtn">âš™ï¸</div>
      </div>
    </div>

    <div class="grid">
      <div class="left-panel">
        <h3>ä»Šæ—¥ã®äºˆå®š</h3>
        <div id="todayList"></div>
      </div>

      <div class="center-panel">
        <div class="big-card" id="bigCard">
          <div class="title" id="currentTitle">äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“</div>
          <div class="time" id="currentTime">--:-- â€” --:--</div>
          <div class="remaining" id="remaining">â€” åˆ†</div>
          <div class="small-card" id="next1">æ¬¡äºˆå®šï¼šãªã—</div>
          <div class="small-card" id="next2">æ¬¡ã€…äºˆå®šï¼šãªã—</div>
          <div id="memos" style="margin-top:16px;overflow-x:auto;white-space:nowrap"></div>
          <div class="bottom-clock" id="clock">--:--:--</div>
        </div>
      </div>

      <div class="right-panel">
        <h3>ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</h3>
        <a class="btn" href="calendar.html">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>
        <a class="btn" href="kakeibo.html" style="margin-top:6px;">ğŸ’° å®¶è¨ˆç°¿</a>
        <button class="btn" id="addMemoQuick" style="margin-top:6px;">ãƒ¡ãƒ¢è¿½åŠ </button>
      </div>
    </div>
  </div>

  <!-- å¿˜ã‚Œç‰©ãƒã‚§ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="checkModal">
    <div class="panel">
      <h3>å¿˜ã‚Œç‰©ãƒã‚§ãƒƒã‚¯</h3>
      <div id="checkList"></div>
      <button class="btn" onclick="closeModal('checkModal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="settingsModal">
    <div class="panel">
      <h3>è¨­å®š</h3>
      <button class="btn" id="openAddEvent">äºˆå®šè¿½åŠ </button>
      <button class="btn" id="openAddMemo">ãƒ¡ãƒ¢è¿½åŠ </button>
      <button class="btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      <button class="btn" onclick="closeModal('settingsModal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ  -->
  <div class="modal" id="addEventModal">
    <div class="panel">
      <h3>äºˆå®šè¿½åŠ </h3>
      <input id="evDate" class="input" type="date"><br>
      <input id="evStart" class="input" type="time"><br>
      <input id="evEnd" class="input" type="time"><br>
      <input id="evTitle" class="input" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«"><br>
      <button class="btn" id="saveEventBtn">ä¿å­˜</button>
      <button class="btn" onclick="closeModal('addEventModal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- ãƒ¡ãƒ¢è¿½åŠ  -->
  <div class="modal" id="addMemoModal">
    <div class="panel">
      <h3>ãƒ¡ãƒ¢è¿½åŠ </h3>
      <input id="memoTitle" class="input" type="text" placeholder="é¡Œå"><br>
      <textarea id="memoBody" class="input" rows="5" placeholder="å†…å®¹"></textarea><br>
      <button class="btn" id="saveMemoBtn">ä¿å­˜</button>
      <button class="btn" onclick="closeModal('addMemoModal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <audio id="alarmSound" src="Meitetsu.mp3" preload="auto"></audio>

  <script type="module">
    import { db } from "./firebase-config.js";
    import { collection, addDoc, getDocs, onSnapshot, orderBy, query, where, serverTimestamp, doc, deleteDoc } 
      from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const el = id => document.getElementById(id);
    const currentUser = localStorage.getItem("loginUser");
    if (!currentUser) window.location.href = "index.html";
    el("username").textContent = currentUser;

    // æ›œæ—¥
    const weekday = "æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ"[new Date().getDay()];
    el("weekday").textContent = weekday + "æ›œæ—¥";

    // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
    const checklist = ["è²¡å¸ƒ", "éµ", "ã‚¹ãƒãƒ›", "ãƒãƒ³ã‚«ãƒ", "æ°´ç­’"];
    const cl = el("checkList");
    checklist.forEach(i=>{
      const div = document.createElement("div");
      div.textContent = i;
      div.style.padding = "6px";
      div.style.cursor = "pointer";
      div.onclick = ()=>div.classList.toggle("checked");
      cl.appendChild(div);
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
    window.openModal = id => el(id).classList.add("show");
    window.closeModal = id => el(id).classList.remove("show");
    window.logout = () => { localStorage.removeItem("loginUser"); location.href="index.html"; }

    el("checkBtn").onclick = ()=>openModal("checkModal");
    el("settingsBtn").onclick = ()=>openModal("settingsModal");
    el("openAddEvent").onclick = ()=>{ closeModal("settingsModal"); openModal("addEventModal"); };
    el("openAddMemo").onclick = ()=>{ closeModal("settingsModal"); openModal("addMemoModal"); };
    el("addMemoQuick").onclick = ()=>openModal("addMemoModal");
    el("bellBtn").onclick = ()=>{ const s=el("alarmSound"); s.play(); setTimeout(()=>s.pause(),3000); };

    // Firestoreãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å–å¾—
    const todayStr = new Date().toISOString().split("T")[0];
    const eventsCol = collection(db, "events");
    const memosCol = collection(db, "memos");

    let currentEvents = [];

    onSnapshot(query(eventsCol, where("date","==",todayStr), orderBy("start")), snap=>{
      currentEvents = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderToday();
    });

    onSnapshot(query(memosCol, orderBy("createdAt","desc")), snap=>{
      const memos = el("memos"); memos.innerHTML="";
      snap.forEach(d=>{
        const m = d.data();
        const card=document.createElement("div");
        card.className="memo-card";
        card.innerHTML=`<div class='memo-title'>${m.title}</div><div>${m.body}</div>`;
        memos.appendChild(card);
      });
    });

    function renderToday(){
      const cont = el("todayList");
      cont.innerHTML="";
      currentEvents.forEach(e=>{
        const div=document.createElement("div");
        div.className="event-item";
        div.innerHTML=`<div>${e.start} - ${e.end}</div><div>${e.title}</div>`;
        cont.appendChild(div);
      });
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
    el("saveEventBtn").onclick=async()=>{
      const date=el("evDate").value||todayStr;
      const start=el("evStart").value;
      const end=el("evEnd").value;
      const title=el("evTitle").value||"ç„¡é¡Œ";
      await addDoc(eventsCol,{date,start,end,title,owner:currentUser,createdAt:serverTimestamp()});
      closeModal("addEventModal");
    };

    // ãƒ¡ãƒ¢è¿½åŠ 
    el("saveMemoBtn").onclick=async()=>{
      const title=el("memoTitle").value||"ç„¡é¡Œ";
      const body=el("memoBody").value;
      await addDoc(memosCol,{title,body,owner:currentUser,createdAt:serverTimestamp()});
      closeModal("addMemoModal");
    };

    // æ™‚è¨ˆ
    setInterval(()=>{
      const n=new Date();
      el("clock").textContent=n.toLocaleTimeString();
    },1000);
  </script>
</body>
</html>


