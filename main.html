<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CAST - ãƒ¡ã‚¤ãƒ³</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
      <div class="header-left">
        <div class="logo">CAST</div>
        <div class="user-block">
          <div id="username" class="name">ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
          <div id="weekday" class="weekday">1</div>
        </div>
      </div>

      <div class="header-right">
        <div class="icon-btn" id="checkBtn" title="å¿˜ã‚Œç‰©ãƒã‚§ãƒƒã‚¯">ğŸ§°</div>
        <div class="icon-btn" id="bellBtn" title="ã‚¢ãƒ©ãƒ¼ãƒ ">ğŸ””</div>
        <div class="icon-btn" id="settingsBtn" title="è¨­å®š">âš™ï¸</div>
      </div>
    </div>

    <!-- ã‚°ãƒªãƒƒãƒ‰æ§‹æˆ -->
    <div class="grid">
      <!-- å·¦ãƒ‘ãƒãƒ«ï¼šä»Šæ—¥ã®äºˆå®š -->
      <div class="left-panel" id="leftPanel">
        <h3 style="margin-bottom:10px">æœ¬æ—¥ã®äºˆå®š</h3>
        <div id="todayList"></div>
      </div>

      <!-- ä¸­å¤®ãƒ‘ãƒãƒ« -->
      <div class="center-panel">
        <div class="big-card" id="bigCard">
          <div class="title" id="currentTitle">äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“</div>
          <div class="time" id="currentTime">--:-- â€” --:--</div>
          <div class="remaining" id="remaining">â€” åˆ†</div>

          <div class="side-cards">
            <div class="small-card" id="next1">æ¬¡äºˆå®šï¼šãªã—</div>
            <div class="small-card" id="next2">æ¬¡ã€…äºˆå®šï¼šãªã—</div>
          </div>

          <div class="memos" id="memos"></div>

          <div class="bottom-clock" id="clock">--:--:--</div>
        </div>
      </div>

      <!-- å³ãƒ‘ãƒãƒ« -->
      <div>
        <div style="background:linear-gradient(180deg,#0d1113,#0a0a0a);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)">
          <div style="margin-bottom:8px;font-weight:700">ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <a class="btn" href="calendar.html">å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¸</a>
            <a class="btn" href="kakeibo.html">å®¶è¨ˆç°¿ã¸</a>
            <button class="btn alt" id="addMemoQuick">ãƒ¡ãƒ¢è¿½åŠ </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- audio -->
  <audio id="alarmSound" src="Meitetsu.mp3" preload="auto"></audio>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="checkModal">
    <div class="panel">
      <h3>å¿˜ã‚Œç‰©ãƒã‚§ãƒƒã‚¯</h3>
      <div class="check-list" id="checkList"></div>
      <div style="margin-top:12px;text-align:right">
        <button class="btn" id="checkConfirm">ç¢ºèª</button>
        <button class="btn alt" onclick="closeModal('checkModal')">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <div class="modal" id="settingsModal">
    <div class="panel">
      <h3>è¨­å®š</h3>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn" id="openAddEvent">äºˆå®šè¿½åŠ </button>
        <button class="btn" id="openAddMemo">ãƒ¡ãƒ¢è¿½åŠ </button>
        <a class="btn" href="calendar.html">å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>
        <a class="btn" href="kakeibo.html">å®¶è¨ˆç°¿</a>
      </div>
      <div style="margin-top:12px;text-align:right">
        <button class="btn alt" onclick="closeModal('settingsModal')">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- äºˆå®šè¿½åŠ  -->
  <div class="modal" id="addEventModal">
    <div class="panel">
      <h3>äºˆå®šã‚’è¿½åŠ </h3>
      <div class="form-row"><label>æ—¥ä»˜</label><input id="evDate" class="input" type="date" /></div>
      <div class="form-row"><label>é–‹å§‹</label><input id="evStart" class="input" type="time" /></div>
      <div class="form-row"><label>çµ‚äº†</label><input id="evEnd" class="input" type="time" /></div>
      <div class="form-row"><label>ã‚¿ã‚¤ãƒˆãƒ«</label><input id="evTitle" class="input" type="text" /></div>
      <div style="text-align:right">
        <button class="btn" id="saveEventBtn">è¿½åŠ </button>
        <button class="btn alt" onclick="closeModal('addEventModal')">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ãƒ¢è¿½åŠ  -->
  <div class="modal" id="addMemoModal">
    <div class="panel">
      <h3>ãƒ¡ãƒ¢ã‚’è¿½åŠ </h3>
      <div class="form-row"><label>é¡Œå</label><input id="memoTitle" class="input" type="text" /></div>
      <div class="form-row"><label>å†…å®¹</label><textarea id="memoBody" class="input" rows="5"></textarea></div>
      <div style="text-align:right">
        <button class="btn" id="saveMemoBtn">ä¿å­˜</button>
        <button class="btn alt" onclick="closeModal('addMemoModal')">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script type="module">
    import { db } from './firebase-config.js';
    import {
      collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, doc, deleteDoc
    } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    const el = id => document.getElementById(id);
    const user = localStorage.getItem('loginUser') || 'ã‚²ã‚¹ãƒˆ';
    el('username').textContent = user;
    const wday = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    el('weekday').textContent = wday[new Date().getDay()];

    const checklistItems = ['è²¡å¸ƒ','ã‚¹ãƒãƒ›','æ°´ç­’','éµ','ãƒãƒ³ã‚«ãƒ','å®šæœŸ','ãƒªãƒƒãƒ—','æ­¯ãƒ–ãƒ©ã‚·'];
    const list = el('checkList');
    checklistItems.forEach(it=>{
      const d=document.createElement('div');
      d.className='check-item';
      d.textContent=it;
      d.onclick=()=>d.classList.toggle('checked');
      list.appendChild(d);
    });
    el('checkConfirm').onclick=()=>closeModal('checkModal');

    // modal open/close
    window.closeModal = id => document.getElementById(id).classList.remove('show');
    const openModal = id => document.getElementById(id).classList.add('show');
    el('checkBtn').onclick=()=>openModal('checkModal');
    el('settingsBtn').onclick=()=>openModal('settingsModal');
    el('openAddEvent').onclick=()=>{closeModal('settingsModal');openModal('addEventModal');};
    el('openAddMemo').onclick=()=>{closeModal('settingsModal');openModal('addMemoModal');};
    el('addMemoQuick').onclick=()=>openModal('addMemoModal');
    el('bellBtn').onclick=()=>{
      const s=el('alarmSound');
      s.currentTime=0; s.play();
      setTimeout(()=>s.pause(),3000);
    };

    // Firestore
    const eventsCol=collection(db,'events');
    const memosCol=collection(db,'memos');
    const todayStr=new Date().toISOString().split('T')[0];
    let events=[];

    // Events
    const qToday=query(eventsCol,where('date','==',todayStr),orderBy('start'));
    onSnapshot(qToday,snap=>{
      events=[]; snap.forEach(d=>events.push({id:d.id,...d.data()}));
      renderList(); updateMain();
    });

    function renderList(){
      const box=el('todayList'); box.innerHTML='';
      events.forEach(e=>{
        const div=document.createElement('div');
        div.className='event-item'+(e.owner!==user?' other':'');
        div.innerHTML=`<div class="event-time">${e.start} - ${e.end}</div><div class="event-title">${e.title}</div>`;
        div.onclick=()=>alert(`${e.title}\n${e.date} ${e.start}-${e.end}\n${e.owner||''}`);
        box.appendChild(div);
      });
    }

    function updateMain(){
      const now=new Date(); const nMin=now.getHours()*60+now.getMinutes();
      const parsed=events.map(e=>{
        const [sh,sm]=e.start.split(':').map(Number);
        const [eh,em]=e.end.split(':').map(Number);
        return {...e,sMin:sh*60+sm,eMin:eh*60+em};
      }).sort((a,b)=>a.sMin-b.sMin);

      let cur=parsed.find(p=>p.sMin<=nMin&&nMin<p.eMin);
      let next=parsed.find(p=>p.sMin>nMin);
      let next2=parsed.filter(p=>p.sMin>nMin)[1];

      el('currentTitle').textContent=cur?cur.title:'äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“';
      el('currentTime').textContent=cur?`${cur.start} â€” ${cur.end}`:'--:-- â€” --:--';
      el('next1').textContent=next?`æ¬¡äºˆå®šï¼š${next.title} (${next.start})`:'æ¬¡äºˆå®šï¼šãªã—';
      el('next2').textContent=next2?`æ¬¡ã€…äºˆå®šï¼š${next2.title} (${next2.start})`:'æ¬¡ã€…äºˆå®šï¼šãªã—';
      el('remaining').textContent=cur?`${cur.eMin-nMin} åˆ†`:'â€” åˆ†';
    }

    // Memos
    onSnapshot(query(memosCol,orderBy('createdAt','desc')),snap=>{
      const box=el('memos'); box.innerHTML='';
      snap.forEach(d=>{
        const m=d.data();
        const card=document.createElement('div');
        card.className='memo-card'+(m.owner!==user?' other':'');
        card.innerHTML=`<div class="memo-title">${m.title}</div><div class="memo-body">${m.body}</div>`;
        card.onclick=()=>alert(m.body);
        box.appendChild(card);
      });
    });

    // Add event/memo
    el('saveEventBtn').onclick=async()=>{
      const date=el('evDate').value||todayStr;
      const start=el('evStart').value;
      const end=el('evEnd').value;
      const title=el('evTitle').value||'ç„¡é¡Œ';
      await addDoc(eventsCol,{date,start,end,title,owner:user,createdAt:serverTimestamp()});
      closeModal('addEventModal');
      el('evDate').value=el('evStart').value=el('evEnd').value=el('evTitle').value='';
    };

    el('saveMemoBtn').onclick=async()=>{
      const title=el('memoTitle').value||'ç„¡é¡Œ';
      const body=el('memoBody').value;
      await addDoc(memosCol,{title,body,owner:user,createdAt:serverTimestamp()});
      closeModal('addMemoModal');
      el('memoTitle').value=el('memoBody').value='';
    };

    setInterval(()=>{
      el('clock').textContent=new Date().toLocaleTimeString();
      updateMain();
    },1000);
  </script>
</body>
</html>


