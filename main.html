<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CAST - メイン</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="header-left">
        <div class="logo">CAST</div>
        <div class="user-block">
          <div id="username" class="name">ユーザー</div>
          <div id="weekday" class="weekday">1</div>
        </div>
      </div>

      <div class="header-right">
        <div class="icon-btn" id="checkBtn" title="忘れ物チェック">🧰</div>
        <div class="icon-btn" id="bellBtn" title="アラーム">🔔</div>
        <div class="icon-btn" id="settingsBtn" title="設定">⚙️</div>
      </div>
    </div>

    <div class="grid">
      <!-- left: today's schedule -->
      <div class="left-panel" id="leftPanel">
        <h3 style="margin-bottom:10px">本日の予定</h3>
        <div id="todayList"></div>
      </div>

      <!-- center: main big card + memos -->
      <div class="center-panel">
        <div class="big-card" id="bigCard">
          <div class="title" id="currentTitle">予定がありません</div>
          <div class="time" id="currentTime">00:00 — 00:00</div>
          <div class="remaining" id="remaining">— 分</div>

          <div class="side-cards">
            <div class="small-card" id="next1">次予定：なし</div>
            <div class="small-card" id="next2">次々予定：なし</div>
          </div>

          <div class="memos" id="memos">
            <!-- horizontal scroll of memo cards -->
          </div>

          <div class="bottom-clock" id="clock">--:--:--</div>
        </div>
      </div>

      <!-- right: quick controls / placeholder -->
      <div>
        <div style="background:linear-gradient(180deg,#0d1113,#0a0a0a);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)">
          <div style="margin-bottom:8px;font-weight:700">ショートカット</div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <a class="btn" href="calendar.html">共有カレンダーへ</a>
            <a class="btn" href="kakeibo.html">家計簿へ</a>
            <button class="btn alt" id="addMemoQuick">メモ追加</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- audio -->
  <audio id="alarmSound" src="Meitetsu.mp3" preload="auto"></audio>

  <!-- modals -->
  <div class="modal" id="checkModal">
    <div class="panel">
      <h3>忘れ物チェック</h3>
      <div class="check-list" id="checkList">
        <!-- items appended -->
      </div>
      <div style="margin-top:12px;text-align:right">
        <button class="btn" id="checkConfirm">確認</button>
        <button class="btn alt" onclick="closeModal('checkModal')">閉じる</button>
      </div>
    </div>
  </div>

  <div class="modal" id="settingsModal">
    <div class="panel">
      <h3>設定</h3>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn" id="openAddEvent">予定追加</button>
        <button class="btn" id="openAddMemo">メモ追加</button>
        <a class="btn" href="calendar.html">共有カレンダー</a>
        <a class="btn" href="kakeibo.html">家計簿</a>
      </div>
      <div style="margin-top:12px;text-align:right">
        <button class="btn alt" onclick="closeModal('settingsModal')">閉じる</button>
      </div>
    </div>
  </div>

  <!-- add event modal -->
  <div class="modal" id="addEventModal">
    <div class="panel">
      <h3>予定を追加</h3>
      <div class="form-row">
        <label>日付</label>
        <input id="evDate" class="input" type="date" />
      </div>
      <div class="form-row">
        <label>開始時間</label>
        <input id="evStart" class="input" type="time" />
      </div>
      <div class="form-row">
        <label>終了時間</label>
        <input id="evEnd" class="input" type="time" />
      </div>
      <div class="form-row">
        <label>タイトル</label>
        <input id="evTitle" class="input" type="text" />
      </div>
      <div style="text-align:right">
        <button class="btn" id="saveEventBtn">追加</button>
        <button class="btn alt" onclick="closeModal('addEventModal')">閉じる</button>
      </div>
    </div>
  </div>

  <!-- add memo modal -->
  <div class="modal" id="addMemoModal">
    <div class="panel">
      <h3>メモを追加</h3>
      <div class="form-row">
        <label>題名</label><input id="memoTitle" class="input" type="text" />
      </div>
      <div class="form-row">
        <label>内容</label><textarea id="memoBody" class="input" rows="5"></textarea>
      </div>
      <div style="text-align:right">
        <button class="btn" id="saveMemoBtn">保存</button>
        <button class="btn alt" onclick="closeModal('addMemoModal')">閉じる</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from './firebase-config.js';
    import {
      collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, doc, updateDoc, deleteDoc
    } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    // --- utility ---
    const el = id => document.getElementById(id);
    const currentUser = localStorage.getItem('loginUser') || null;
    if (!currentUser) {
      window.location.href = 'login.html';
    }
    el('username').textContent = currentUser;

    // weekday number big: show weekday name or number "1" as in image
    const weekday = new Date().getDay(); // 0=Sun..6
    el('weekday').textContent = weekday === 0 ? '日' : weekday;

    // checklist items
    const checklistItems = ['免許証','財布','水筒','ハンカチ','スタンプ帳','エコバック','リップ','歯ブラシ','お風呂セット'];
    const checkList = el('checkList');
    checklistItems.forEach(it=>{
      const d = document.createElement('div');
      d.className = 'check-item';
      d.textContent = it;
      d.onclick = ()=> d.classList.toggle('checked');
      checkList.appendChild(d);
    });
    el('checkConfirm').onclick = ()=> {
      // just close for now
      closeModal('checkModal');
      alert('確認しました');
    };

    // modal helpers
    window.closeModal = id => document.getElementById(id).classList.remove('show');
    window.openModal = id => document.getElementById(id).classList.add('show');

    // open modals from icons
    el('checkBtn').onclick = ()=> openModal('checkModal');
    el('bellBtn').onclick = ()=> {
      // open alarm settings quickly: toggle sound play
      const sound = el('alarmSound');
      sound.play();
      setTimeout(()=>sound.pause(), 3000);
    };
    el('settingsBtn').onclick = ()=> openModal('settingsModal');

    // settings modal buttons
    el('openAddEvent').onclick = ()=> { closeModal('settingsModal'); openModal('addEventModal') };
    el('openAddMemo').onclick = ()=> { closeModal('settingsModal'); openModal('addMemoModal') };
    el('addMemoQuick').onclick = ()=> openModal('addMemoModal');

    // ---------- Firestore realtime listeners ----------
    const eventsCol = collection(db, 'events');
    const memosCol = collection(db, 'memos');

    // listen memos (all users). Show horizontally; red bordered card for memos
    onSnapshot(query(memosCol, orderBy('createdAt','desc')), snap=>{
      const out = el('memos'); out.innerHTML = '';
      snap.forEach(docu=>{
        const d = docu.data();
        const card = document.createElement('div');
        card.className = 'memo-card';
        card.innerHTML = `<div class="memo-title">${d.title}</div><div class="memo-body">${d.body}</div><div style="margin-top:8px;font-size:12px;color:var(--muted)">${d.owner || '誰か'}</div>`;
        card.onclick = ()=> alert('メモ：'+(d.title||'')+'\n\n'+(d.body||''));
        out.appendChild(card);
      });
    });

    // listen today's events (we'll query by date string yyyy-mm-dd)
    function formatDateYMD(dt){
      const y=dt.getFullYear();
      const m=('0'+(dt.getMonth()+1)).slice(-2);
      const d=('0'+dt.getDate()).slice(-2);
      return `${y}-${m}-${d}`;
    }
    const todayStr = formatDateYMD(new Date());
    const qToday = query(eventsCol, where('date','==', todayStr), orderBy('start'));
    let currentEvents = []; // cached
    onSnapshot(qToday, snap=>{
      currentEvents = [];
      snap.forEach(docu=>{
        const d = {...docu.data(), id:docu.id};
        currentEvents.push(d);
      });
      renderTodayList();
      updateCurrentDisplay();
    });

    // render left list
    function renderTodayList(){
      const container = el('todayList'); container.innerHTML='';
      currentEvents.forEach(it=>{
        const item = document.createElement('div');
        item.className = 'event-item' + (it.owner && it.owner !== currentUser ? ' other' : '');
        item.innerHTML = `<div class="event-time">${it.start} - ${it.end}</div><div class="event-title">${it.title}</div>`;
        item.onclick = ()=> showEventDetail(it);
        container.appendChild(item);
      });
    }

    // show event detail popup (simple)
    function showEventDetail(ev){
      alert(`${ev.title}\n${ev.date} ${ev.start}-${ev.end}\n作成者: ${ev.owner || '不明'}`);
    }

    // find current event and next ones
    function updateCurrentDisplay(){
      const now = new Date();
      const nowMin = now.getHours()*60 + now.getMinutes();
      // parse event times to minutes
      const parsed = currentEvents.map(e=>{
        const [sh,sm]=e.start.split(':').map(x=>parseInt(x,10));
        const [eh,em]=e.end.split(':').map(x=>parseInt(x,10));
        return {...e, sMin:sh*60+sm, eMin:eh*60+em};
      }).sort((a,b)=>a.sMin-b.sMin);

      // current: the one where now between start and end; if none, the next upcoming (first with sMin>now)
      let current = parsed.find(p=>p.sMin <= nowMin && nowMin < p.eMin);
      let next = parsed.find(p=>p.sMin > nowMin);
      let next2 = parsed.filter(p=>p.sMin > nowMin)[1];

      if (!current && next) {
        // if no active, set current to next (as display) until its time begins
        current = next;
        next = next2;
        next2 = parsed.filter(p=>p.sMin > current.sMin)[1];
      }

      // update DOM
      el('currentTitle').textContent = current ? current.title : '予定がありません';
      el('currentTime').textContent = current ? `${current.start} — ${current.end}` : '--:-- — --:--';
      el('next1').textContent = next ? `次予定：${next.title} (${next.start})` : '次予定：なし';
      el('next2').textContent = next2 ? `次々予定：${next2.title} (${next2.start})` : '次々予定：なし';

      // remaining minutes until current end
      if (current){
        const remain = current.eMin - nowMin;
        el('remaining').textContent = `${remain} 分`;
        // if remain <=0 remove or mark done (we'll delete)
        if (remain <= 0){
          // delete the event doc from firestore
          deleteEventByTitleAndDate(current.id);
        }
      } else {
        el('remaining').textContent = '— 分';
      }
    }

    async function deleteEventByTitleAndDate(id){
      try{
        await deleteDoc(doc(db,'events',id));
      }catch(e){
        console.error('del err',e);
      }
    }

    // live clock
    setInterval(()=>{
      const n = new Date();
      el('clock').textContent = n.toLocaleTimeString();
      updateCurrentDisplay();
    },1000);

    // save event
    el('saveEventBtn').onclick = async ()=>{
      const date = el('evDate').value || todayStr;
      const start = el('evStart').value || '00:00';
      const end = el('evEnd').value || '00:00';
      const title = el('evTitle').value || '無題';
      if (!title) return alert('タイトル必要');
      await addDoc(collection(db,'events'),{
        date, start, end, title, owner: currentUser, createdAt: serverTimestamp()
      });
      closeModal('addEventModal');
      el('evTitle').value=''; el('evStart').value=''; el('evEnd').value='';
    };

    // save memo
    el('saveMemoBtn').onclick = async ()=>{
      const title = el('memoTitle').value || '無題';
      const body = el('memoBody').value || '';
      await addDoc(collection(db,'memos'),{
        title, body, owner: currentUser, createdAt: serverTimestamp()
      });
      closeModal('addMemoModal');
      el('memoTitle').value=''; el('memoBody').value='';
    };

    // show event detail when clicking center big card
    el('bigCard').onclick = ()=> {
      // show current event details (if any)
      // find first current or next
      const now = new Date(); const nowMin = now.getHours()*60 + now.getMinutes();
      const parsed = currentEvents.map(e=>{
        const [sh,sm]=e.start.split(':').map(x=>parseInt(x,10));
        const [eh,em]=e.end.split(':').map(x=>parseInt(x,10));
        return {...e, sMin:sh*60+sm, eMin:eh*60+em};
      }).sort((a,b)=>a.sMin-b.sMin);
      let current = parsed.find(p=>p.sMin <= nowMin && nowMin < p.eMin) || parsed.find(p=>p.sMin > nowMin) || null;
      if (current) showEventDetail(current);
      else alert('予定はありません');
    };

    // lifecycle: ensure login user set in localStorage
    // logout helper
    window.addEventListener('load', ()=> {
      // nothing
    });

  </script>
</body>
</html>


